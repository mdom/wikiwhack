#!/bin/sh

base_url=""

if [ -e "$HOME/.wikiwhackrc" ]; then
    . "$HOME/.wikiwhackrc"
fi

if [ -z "$base_url" ]; then
    printf "Config parameter base_url is not set." >&2
    exit 1
fi

get(){
    curl -sS -H "Content-Type: application/json" "$base_url/wiki/$1.json?key=$REDMINE_APIKEY"
}

put(){
    curl -sS --request PUT --data-binary @- -H "Content-Type: application/json" "$base_url/wiki/$1.json?key=$REDMINE_APIKEY"
}

_search(){
    curl -sS --get -H "Content-Type: application/json" "$base_url/search.json?key=$REDMINE_APIKEY" -d "q=$1" -d "offset=$2" -d "limit=$3"
}

esc=$(printf '\033')
bold="${esc}[1m"
normal="${esc}[0m"

filter_page(){
    awk '
        BEGIN {
            bold   = "\x1b[1m"
            normal = "\x1b[0m"
        }
        /^h[0-9]\([^)]+\)\./{
            sub(/\([^)]+\)/, "")
        }
        /^h[0-9]./{
            print bold $0 normal
            next
        }
        {print}
    '
}

get_titles(){
    get 'index' | jq -r '.wiki_pages|.[]|.title'
}

get_text(){
    get "$1" | jq -r '.wiki_page|.text'
}

cat_page(){
    get_text "$1" |filter_page
}

less_page(){
    get_text "$1" |filter_page > .wikiwhack.$$.tmp
    less -R .wikiwhack.$$.tmp
    rm .wikiwhack.$$.tmp
}

edit_page(){
    get_text "$1" > .wikiwhack.$$.tmp
    $EDITOR .wikiwhack.$$.tmp < /dev/tty
    jq --slurp -R '{"wiki_page": { "text": . }}' < .wikiwhack.$$.tmp | put "$1"
    rm .wikiwhack.$$.tmp
}

search(){
        if [ -z "$1" ]; then
            get_titles
        fi
        total_count=$( _search "$1" 0 1 | jq '(.total_count//0)')

        if [ "$total_count" -eq 0 ]; then
            return
        fi

        offset=0
        while [ "$offset" -lt "$total_count" ]; do
            _search "$1" $offset 100 | jq -r '.results|.[]|.title'|sed 's/^Wiki: //' >> .wikiwhack.$$.tmp
            offset=$(( offset + 100 ))
        done

        cat .wikiwhack.$$.tmp
        rm .wikiwhack.$$.tmp
}

case $1 in
    edit ) 
        edit_page "$2"
        ;;
    less ) 
        less_page "$2"
        ;;
    search )
        search "$2"
        ;;
    titles )
        get_titles
        ;;
    cat )
        cat_page "$2"
        ;;
    "")
        get_titles | fzf \
            --preview="$0 cat {}" \
            --layout=reverse \
            --bind="enter:toggle-preview" \
            --bind="ctrl-s:reload#$0 search {q}#+clear-query" \
            --bind="ctrl-e:execute:$0 edit {}" \
            --bind="ctrl-l:execute:$0 less {}" \
            --bind="ctrl-j:preview-half-page-down" \
            --bind="ctrl-k:preview-half-page-up" \
            --color="header:bold" \
            --info=inline \
            --ansi \
            --preview-window=hidden \
            --header='C-e:edit C-s:search C-l:less ENTER:preview C-q:quit'
        ;;
esac
